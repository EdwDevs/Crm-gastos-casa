<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM Financiero Familiar Serrano</title>
  <!-- Iconos y fuentes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    /* =============================== */
    /* Estilos base y variables        */
    /* =============================== */
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', -apple-system, BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif; }
    :root{
      --primary:#667eea; --primary-dark:#5a67d8; --secondary:#764ba2; --accent:#f093fb;
      --success:#48bb78; --success-light:#68d391; --danger:#f56565; --danger-light:#fc8181;
      --warning:#ed8936; --warning-light:#f6ad55; --info:#4299e1; --info-light:#63b3ed;
      --dark:#2d3748; --light:#f7fafc; --gray:#718096; --gray-light:#e2e8f0; --white:#ffffff;
      --card-bg:rgba(255,255,255,0.9); --sidebar-bg:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --header-bg:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
      --shadow-sm:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);
      --shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
      --shadow-xl:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);
    }
    body{ background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%); color:var(--dark); display:flex; min-height:100vh; font-size:14px; line-height:1.6;}
    .sidebar-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:99; backdrop-filter:blur(3px); }
    /* =============================== */
    /* Sidebar                         */
    /* =============================== */
    .sidebar{ width:280px; background:var(--sidebar-bg); color:#fff; height:100vh; position:fixed; padding:0; box-shadow:var(--shadow-xl); z-index:1000; transition:all .4s cubic-bezier(.25,.8,.25,1); backdrop-filter:blur(20px);}
    .logo{ text-align:center; padding:30px 20px; border-bottom:1px solid rgba(255,255,255,.15); margin-bottom:20px; background:rgba(255,255,255,.1); backdrop-filter:blur(10px);}
    .logo h1{ font-size:1.75rem; font-weight:800; letter-spacing:-.025em; margin-bottom:8px; background:linear-gradient(135deg,#fff 0%,#f093fb 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
    .logo .subtitle{ font-size:.875rem; opacity:.8; font-weight:400;}
    .nav-links{ padding:10px 20px;}
    .nav-links li{ list-style:none; margin:8px 0;}
    .nav-links a{ color:rgba(255,255,255,.85); text-decoration:none; display:flex; align-items:center; padding:16px 20px; border-radius:12px; transition:all .3s cubic-bezier(.25,.8,.25,1); min-height:52px; font-weight:500; font-size:.95rem; position:relative; overflow:hidden;}
    .nav-links a::before{ content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent); transition:left .5s;}
    .nav-links a:hover::before{ left:100%;}
    .nav-links a:hover,.nav-links a.active{ background:rgba(255,255,255,.15); color:#fff; transform:translateX(8px); box-shadow:var(--shadow-md);}
    .nav-links a.active{ background:rgba(255,255,255,.2); border-left:4px solid var(--accent);}
    .nav-links i{ margin-right:16px; font-size:1.2rem; width:20px; text-align:center;}
    /* =============================== */
    /* Main y Header                   */
    /* =============================== */
    .main-content{ flex:1; margin-left:280px; padding:25px; background:rgba(255,255,255,.05); backdrop-filter:blur(10px);}
    .header{ background:var(--header-bg); color:#fff; padding:30px; border-radius:20px; margin-bottom:30px; box-shadow:var(--shadow-lg); display:flex; justify-content:space-between; align-items:center; backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.2); position:relative; overflow:hidden;}
    .header::before{ content:''; position:absolute; inset:0; background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");}
    .header > *{ position:relative; z-index:1;}
    .header h2{ font-weight:700; font-size:1.5rem; letter-spacing:-.025em;}
    .user-info{ display:flex; align-items:center; background:rgba(255,255,255,.15); padding:12px 20px; border-radius:50px; backdrop-filter:blur(10px);}
    .user-info img{ width:44px; height:44px; border-radius:50%; margin-right:12px; object-fit:cover; border:2px solid rgba(255,255,255,.3);}
    .user-info span{ font-weight:600;}
    /* =============================== */
    /* Resumen (cards)                 */
    /* =============================== */
    .summary-cards{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:24px; margin-bottom:40px;}
    .summary-card{ background:var(--card-bg); border-radius:20px; padding:30px; text-align:center; box-shadow:var(--shadow-md); transition:all .3s cubic-bezier(.25,.8,.25,1); border:1px solid rgba(255,255,255,.5); backdrop-filter:blur(20px); position:relative; overflow:hidden;}
    .summary-card::before{ content:''; position:absolute; top:0; left:0; right:0; height:4px; background:linear-gradient(90deg,var(--primary),var(--accent));}
    .summary-card:hover{ transform:translateY(-8px) scale(1.02); box-shadow:var(--shadow-xl);}
    .summary-card:nth-child(1)::before{ background:linear-gradient(90deg,var(--success),var(--success-light)); }
    .summary-card:nth-child(2)::before{ background:linear-gradient(90deg,var(--danger),var(--danger-light)); }
    .summary-card:nth-child(3)::before{ background:linear-gradient(90deg,var(--info),var(--info-light)); }
    .summary-card:nth-child(4)::before{ background:linear-gradient(90deg,var(--warning),var(--warning-light)); }
    .summary-card i{ font-size:2.5rem; margin-bottom:20px; background:linear-gradient(135deg,var(--primary),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
    .summary-card:nth-child(1) i{ background:linear-gradient(135deg,var(--success),var(--success-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
    .summary-card:nth-child(2) i{ background:linear-gradient(135deg,var(--danger),var(--danger-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
    .summary-card:nth-child(3) i{ background:linear-gradient(135deg,var(--info),var(--info-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
    .summary-card:nth-child(4) i{ background:linear-gradient(135deg,var(--warning),var(--warning-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
    .summary-card h3{ font-size:2.25rem; margin-bottom:8px; font-weight:800; letter-spacing:-.025em; color:var(--dark);}
    .summary-card p{ color:var(--gray); font-size:.95rem; font-weight:500;}
    /* =============================== */
    /* Dashboard (cards grandes)       */
    /* =============================== */
    .dashboard{ display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:24px; margin-bottom:40px;}
    .card{ background:var(--card-bg); border-radius:20px; padding:30px; box-shadow:var(--shadow-md); transition:all .3s cubic-bezier(.25,.8,.25,1); border:1px solid rgba(255,255,255,.5); backdrop-filter:blur(20px); position:relative; overflow:hidden;}
    .card:hover{ transform:translateY(-6px); box-shadow:var(--shadow-xl);}
    .card-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;}
    .card-title{ font-size:1.1rem; font-weight:600; color:var(--dark); }
    .card-icon{ width:60px; height:60px; border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:1.5rem; background:linear-gradient(135deg,var(--primary),var(--accent)); color:#fff; box-shadow:var(--shadow-md);}
    .bg-success .card-icon{ background:linear-gradient(135deg,var(--success),var(--success-light)); }
    .bg-danger .card-icon{ background:linear-gradient(135deg,var(--danger),var(--danger-light)); }
    .bg-primary .card-icon{ background:linear-gradient(135deg,var(--primary),var(--accent)); }
    .card-value{ font-size:2.25rem; font-weight:800; margin-bottom:8px; background:linear-gradient(135deg,var(--dark),var(--gray)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
    .card-footer{ font-size:.9rem; color:var(--gray); font-weight:500;}
    /* =============================== */
    /* Formularios                     */
    /* =============================== */
    .form-section{ background:var(--card-bg); border-radius:20px; padding:35px; margin-bottom:40px; box-shadow:var(--shadow-md); border:1px solid rgba(255,255,255,.5); backdrop-filter:blur(20px);}
    .section-title{ font-size:1.5rem; margin-bottom:25px; padding-bottom:15px; border-bottom:2px solid var(--gray-light); color:var(--dark); font-weight:700; display:flex; align-items:center; gap:12px;}
    .form-row{ display:flex; flex-wrap:wrap; margin:0 -12px;}
    .form-group{ flex:1 0 220px; padding:0 12px; margin-bottom:24px;}
    label{ display:block; margin-bottom:10px; font-weight:600; color:var(--dark); font-size:.9rem; letter-spacing:.025em;}
    input,select,textarea{ width:100%; padding:16px 20px; border:2px solid var(--gray-light); border-radius:12px; font-size:16px; min-height:52px; transition:all .3s cubic-bezier(.25,.8,.25,1); background:rgba(255,255,255,.8); backdrop-filter:blur(10px); font-weight:500;}
    input:focus,select:focus,textarea:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 4px rgba(102,126,234,.15); transform:translateY(-2px); background:#fff;}
    .btn{ padding:16px 32px; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition:all .3s cubic-bezier(.25,.8,.25,1); min-height:52px; min-width:52px; position:relative; overflow:hidden; letter-spacing:.025em;}
    .btn::before{ content:''; position:absolute; inset:0; left:-100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent); transition:left .5s;}
    .btn:hover::before{ left:100%;}
    .btn-primary{ background:linear-gradient(135deg,var(--primary),var(--accent)); color:#fff; box-shadow:var(--shadow-md);}
    .btn-primary:hover{ transform:translateY(-3px); box-shadow:var(--shadow-lg);}
    .btn-block{ display:block; width:100%;}
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }
    /* =============================== */
    /* Tablas                          */
    /* =============================== */
    .table-container{ background:var(--card-bg); border-radius:20px; padding:30px; box-shadow:var(--shadow-md); overflow:hidden; margin-bottom:40px; border:1px solid rgba(255,255,255,.5); backdrop-filter:blur(20px);}
    table{ width:100%; border-collapse:collapse;}
    th,td{ padding:18px; text-align:left; border-bottom:1px solid var(--gray-light);}
    th{ font-weight:700; color:var(--dark); background:linear-gradient(135deg, rgba(102,126,234,.08), rgba(240,147,251,.08)); font-size:.9rem; letter-spacing:.05em; text-transform:uppercase;}
    tr:hover{ background:linear-gradient(135deg, rgba(102,126,234,.03), rgba(240,147,251,.03));}
    .badge{ padding:8px 16px; border-radius:20px; font-size:.85rem; font-weight:600; letter-spacing:.025em;}
    .badge-income{ background:linear-gradient(135deg,var(--success),var(--success-light)); color:#fff; box-shadow:0 4px 12px rgba(72,187,120,.3);}
    .badge-expense{ background:linear-gradient(135deg,var(--danger),var(--danger-light)); color:#fff; box-shadow:0 4px 12px rgba(245,101,101,.3);}
    .badge-transfer{ background:linear-gradient(135deg,var(--info),var(--info-light)); color:#fff; box-shadow:0 4px 12px rgba(66,153,225,.3);}
    .action-btn{ background:none; border:none; color:var(--gray); cursor:pointer; font-size:1.2rem; margin:0 6px; transition:all .3s cubic-bezier(.25,.8,.25,1); min-height:48px; min-width:48px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center;}
    .action-btn:hover{ color:var(--primary); background:rgba(102,126,234,.1); transform:translateY(-2px);}
    /* =============================== */
    /* Estados, loading y filtro       */
    /* =============================== */
    .status{ padding:20px; border-radius:16px; margin:15px 0; text-align:center; font-weight:600; backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.3);}
    .status-connected{ background:linear-gradient(135deg, rgba(72,187,120,.15), rgba(104,211,145,.15)); color:var(--success); border-color:rgba(72,187,120,.3);}
    .status-disconnected{ background:linear-gradient(135deg, rgba(245,101,101,.15), rgba(252,129,129,.15)); color:var(--danger); border-color:rgba(245,101,101,.3);}
    .loading{ text-align:center; padding:40px;}
    .spinner{ border:4px solid rgba(102,126,234,.1); border-radius:50%; border-top:4px solid var(--primary); width:48px; height:48px; animation:spin 1s linear infinite; margin:0 auto 20px auto;}
    @keyframes spin{ 0%{ transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }
    .monthly-filter{ display:flex; align-items:center; margin-bottom:24px; gap:16px; flex-wrap:wrap; background:var(--card-bg); padding:20px; border-radius:16px; box-shadow:var(--shadow-sm); backdrop-filter:blur(20px);}
    .monthly-filter label{ margin-bottom:0; font-weight:700; color:var(--dark); display:flex; align-items:center; gap:8px;}
    .monthly-filter select{ width:auto; min-width:200px;}
    .monthly-filter .btn{ padding:14px 24px; font-size:.95rem; min-height:52px;}
    /* =============================== */
    /* Responsive                      */
    /* =============================== */
    @media (max-width:992px){
      .sidebar{ width:80px;}
      .sidebar .logo h1 span, .sidebar .nav-links a span{ display:none;}
      .sidebar .logo h1{ font-size:1.5rem;}
      .sidebar .nav-links i{ margin-right:0; font-size:1.4rem;}
      .sidebar .nav-links a{ justify-content:center; padding:18px;}
      .main-content{ margin-left:80px;}
    }
    @media (max-width:768px){
      .sidebar-overlay.active{ display:block;}
      .main-content{ margin-left:0; padding:16px;}
      .sidebar{ width:300px; transform:translateX(-100%); box-shadow:var(--shadow-xl);}
      .sidebar.active{ transform:translateX(0);}
      .menu-toggle{ display:block; position:fixed; top:24px; left:24px; background:linear-gradient(135deg,var(--primary),var(--accent)); color:#fff; border:none; width:52px; height:52px; border-radius:12px; z-index:101; box-shadow:var(--shadow-lg); font-size:1.2rem;}
      .header{ flex-direction:column; text-align:center; padding:24px; gap:16px;}
      .header h2{ font-size:1.25rem;}
      .summary-cards{ display:flex; overflow-x:auto; gap:20px; padding:0 8px 16px 8px; scroll-snap-type:x mandatory;}
      .summary-card{ min-width:160px; flex-shrink:0; scroll-snap-align:start; padding:20px;}
      .summary-card h3{ font-size:1.6rem;}
      .form-row{ flex-direction:column;}
      .form-group{ flex:none; margin-bottom:16px; padding:0;}
      .monthly-filter{ flex-direction:column; align-items:flex-start;}
      .monthly-filter select,.monthly-filter .btn{ width:100%;}
    }
    @media (max-width:576px){
      .summary-card{ min-width:140px; padding:16px;}
      .summary-card h3{ font-size:1.4rem;}
      .summary-card p{ font-size:.85rem;}
      .form-section{ padding:20px;}
      .header h2{ font-size:1.1rem;}
      .main-content{ padding:12px;}
    }
    .menu-toggle{ display:none;}
    /* =============================== */
    /* Tarjetas de cuentas             */
    /* =============================== */
    .accounts-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; margin-bottom:24px;}
    .account-card{ background:var(--card-bg); border:1px solid rgba(255,255,255,.5); border-left:6px solid var(--primary); padding:18px; border-radius:14px; box-shadow:var(--shadow-sm);}
    .account-card h4{ margin-bottom:6px; font-weight:800;}
    .account-meta{ color:var(--gray); font-size:.85rem; margin-bottom:10px;}
    .account-balance{ font-size:1.3rem; font-weight:800;}
    .account-nequi{ border-left-color:#6d28d9;}
    .account-daviplata{ border-left-color:#ef4444;}
    .account-ahorro{ border-left-color:#10b981;}
    .account-efectivo{ border-left-color:#f59e0b;}
    .small{ font-size:.85rem; color:var(--gray);}
    .muted{ color:var(--gray);}
    .toast{ position:fixed; top:24px; right:24px; display:none; padding:14px 18px; border-radius:12px; color:#fff; box-shadow:var(--shadow-xl); z-index:2000; font-weight:700;}
    .toast.show{ display:block; }
    .toast.success{ background:linear-gradient(135deg,var(--success),var(--success-light));}
    .toast.error{ background:linear-gradient(135deg,var(--danger),var(--danger-light));}
  </style>
</head>
<body>
  <!-- Overlay para mobile -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <!-- =============================== -->
  <!-- Sidebar de navegaci√≥n           -->
  <!-- =============================== -->
  <div class="sidebar" id="sidebar">
    <div class="logo">
      <h1>Familia <span>Serrano</span></h1>
      <div class="subtitle">üí∞ Control Financiero</div>
    </div>
    <ul class="nav-links">
      <li><a href="#" class="active"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
      <li><a href="#"><i class="fas fa-wallet"></i> <span>Ingresos</span></a></li>
      <li><a href="#"><i class="fas fa-shopping-cart"></i> <span>Gastos</span></a></li>
      <li><a href="#"><i class="fas fa-right-left"></i> <span>Transferencias</span></a></li>
      <li><a href="#"><i class="fas fa-chart-pie"></i> <span>Reportes</span></a></li>
      <li><a href="#"><i class="fas fa-cog"></i> <span>Configuraci√≥n</span></a></li>
    </ul>
  </div>

  <!-- =============================== -->
  <!-- Contenido principal             -->
  <!-- =============================== -->
  <div class="main-content">
    <button class="menu-toggle" id="menu-toggle"><i class="fas fa-bars"></i></button>

    <!-- Header -->
    <div class="header">
      <h2><i class="fas fa-chart-line"></i> Dashboard Financiero - Familia Serrano</h2>
      <div class="user-info">
        <img src="https://ui-avatars.com/api/?name=Familia+Serrano&background=667eea&color=fff&bold=true" alt="Familia Serrano"/>
        <span>Familia Serrano</span>
      </div>
    </div>

    <!-- Estado de conexi√≥n Firebase -->
    <div id="connection-status" class="status status-disconnected">
      <i class="fas fa-circle-notch fa-spin"></i> Conectando a Firebase...
    </div>

    <!-- Resumen superior -->
    <div class="summary-cards">
      <div class="summary-card">
        <i class="fas fa-wallet"></i>
        <h3 id="total-income">$0</h3>
        <p>Ingresos Mensuales</p>
      </div>
      <div class="summary-card">
        <i class="fas fa-shopping-cart"></i>
        <h3 id="total-expense">$0</h3>
        <p>Gastos Mensuales</p>
      </div>
      <div class="summary-card">
        <i class="fas fa-piggy-bank"></i>
        <h3 id="total-savings">$0</h3>
        <p>Ahorro Mensual</p>
      </div>
      <div class="summary-card">
        <i class="fas fa-scale-balanced"></i>
        <h3 id="total-balance">$0</h3>
        <p>Balance Total Cuentas</p>
      </div>
    </div>

    <!-- Tarjetas de saldos por cuenta -->
    <div class="form-section">
      <h3 class="section-title"><i class="fas fa-building-columns"></i> Saldos por cuenta</h3>
      <div class="accounts-grid" id="accounts-grid">
        <!-- Se llena din√°micamente desde Firestore -->
      </div>
      <p class="small">üí° Tip: Los retiros de cajero reg√≠strados como transferencia Desde cuenta digital ‚Üí Efectivo (no como gasto)</p>
    </div>

    <!-- KPIs -->
    <div class="dashboard">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Ingresos del Mes</div>
          <div class="card-icon bg-success"><i class="fas fa-arrow-down"></i></div>
        </div>
        <div class="card-value" id="income-value">$0</div>
        <div class="card-footer">Ingresos acumulados del mes</div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Gastos del Mes</div>
          <div class="card-icon bg-danger"><i class="fas fa-arrow-up"></i></div>
        </div>
        <div class="card-value" id="expense-value">$0</div>
        <div class="card-footer">Gastos acumulados del mes</div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Balance</div>
          <div class="card-icon bg-primary"><i class="fas fa-balance-scale"></i></div>
        </div>
        <div class="card-value" id="balance-value">$0</div>
        <div class="card-footer">Ingresos - Gastos (sin transferencias)</div>
      </div>
    </div>

    <!-- Filtro mensual -->
    <div class="monthly-filter">
      <label for="month-selector"><i class="fas fa-calendar-alt"></i> Filtrar por mes:</label>
      <select id="month-selector"></select>
      <button id="new-month-btn" class="btn btn-primary" disabled><i class="fas fa-calendar-plus"></i> Iniciar Nuevo Mes</button>
    </div>

    <!-- Gr√°fico (placeholder visual) -->
    <div class="chart-container">
      <div class="chart-placeholder" style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--gray); font-style:italic; flex-direction:column; gap:16px;">
        <i class="fas fa-chart-bar" style="font-size:4rem; opacity:.6; background:linear-gradient(135deg,var(--primary),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;"></i>
        <p>Historial mensual de ingresos y gastos</p>
      </div>
    </div>

    <!-- =============================== -->
    <!-- Formularios de captura          -->
    <!-- =============================== -->

    <!-- Registrar Ingreso -->
    <div class="form-section">
      <h3 class="section-title"><i class="fas fa-plus-circle"></i> Registrar Ingreso</h3>
      <form id="income-form">
        <div class="form-row">
          <div class="form-group">
            <label for="income-source">üíº Fuente de Ingreso</label>
            <select id="income-source" required>
              <option value="">Seleccionar...</option>
              <option value="salario">üíº Salario Personal</option>
              <option value="salario-esposa">üë©‚Äçüíº Salario Esposa</option>
              <option value="freelance">üíª Trabajos Freelance</option>
              <option value="inversiones">üìà Inversiones</option>
              <option value="otros">üí∞ Otros</option>
            </select>
          </div>
          <div class="form-group">
            <label for="income-amount">üíµ Monto</label>
            <input type="number" id="income-amount" placeholder="0.00" required/>
          </div>
          <div class="form-group">
            <label for="income-date">üìÖ Fecha</label>
            <input type="date" id="income-date" required/>
          </div>
          <div class="form-group">
            <label for="income-account">üè¶ Cuenta destino</label>
            <select id="income-account" required></select>
          </div>
        </div>
        <div class="form-group">
          <label for="income-description">üìù Descripci√≥n</label>
          <textarea id="income-description" rows="2" placeholder="Detalles del ingreso..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" id="income-submit-btn">
          <span class="btn-text"><i class="fas fa-plus-circle"></i> Registrar Ingreso</span>
        </button>
      </form>
    </div>

    <!-- Registrar Gasto -->
    <div class="form-section">
      <h3 class="section-title"><i class="fas fa-minus-circle"></i> Registrar Gasto</h3>
      <form id="expense-form">
        <div class="form-row">
          <div class="form-group">
            <label for="expense-category">üè∑Ô∏è Categor√≠a</label>
            <select id="expense-category" required>
              <option value="">Seleccionar...</option>
              <option value="comida">üçΩÔ∏è Comidas</option>
              <option value="salidas">üéØ Salidas/Entretenimiento</option>
              <option value="tarjetas">üí≥ Pago Tarjetas de Cr√©dito</option>
              <option value="creditos">üè¶ Cr√©ditos (Bancoomeva, Fesfa)</option>
              <option value="gasolina">‚õΩ Gasolina Moto</option>
              <option value="gasolina-carro">üöó Gasolina Carro</option>
              <option value="gastos-varios">üì¶ Gastos Varios</option>
              <option value="agua">üíß Recibo de Agua</option>
              <option value="luz">üí° Recibo de Luz</option>
              <option value="gas">üî• Recibo de Gas</option>
              <option value="celular">üì± Planes M√≥viles</option>
              <option value="internet">üì° Plan de Internet</option>
            </select>
          </div>
          <div class="form-group">
            <label for="expense-amount">üíµ Monto</label>
            <input type="number" id="expense-amount" placeholder="0.00" required/>
          </div>
          <div class="form-group">
            <label for="expense-date">üìÖ Fecha</label>
            <input type="date" id="expense-date" required/>
          </div>
          <div class="form-group">
            <label for="expense-paid-with">üí≥ Pagado con</label>
            <select id="expense-paid-with" required></select>
          </div>
        </div>
        <div class="form-group">
          <label for="expense-description">üìù Descripci√≥n</label>
          <textarea id="expense-description" rows="2" placeholder="Detalles del gasto..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" id="expense-submit-btn">
          <span class="btn-text"><i class="fas fa-plus-circle"></i> Registrar Gasto</span>
        </button>
      </form>
    </div>

    <!-- Transferencias (retiros/traspasos) -->
    <div class="form-section">
      <h3 class="section-title"><i class="fas fa-right-left"></i> Transferir (incluye retiros)</h3>
      <form id="transfer-form">
        <div class="form-row">
          <div class="form-group">
            <label for="transfer-from">Desde</label>
            <select id="transfer-from" required></select>
          </div>
          <div class="form-group">
            <label for="transfer-to">Hacia</label>
            <select id="transfer-to" required></select>
          </div>
          <div class="form-group">
            <label for="transfer-amount">Monto</label>
            <input type="number" id="transfer-amount" required/>
          </div>
          <div class="form-group">
            <label for="transfer-date">Fecha</label>
            <input type="date" id="transfer-date" required/>
          </div>
        </div>
        <div class="form-group">
          <label for="transfer-description">Descripci√≥n</label>
          <textarea id="transfer-description" rows="2" placeholder="Motivo del traspaso o retiro..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i> Registrar Transferencia
        </button>
      </form>
    </div>

    <!-- Transacciones -->
    <div class="table-container">
      <h3 class="section-title"><i class="fas fa-history"></i> Transacciones Recientes</h3>
      <div id="loading-transactions" class="loading">
        <div class="spinner"></div>
        <p>Cargando transacciones desde Firebase...</p>
      </div>
      <table id="transactions-table" style="display:none;">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Categor√≠a</th>
            <th>Descripci√≥n</th>
            <th>Cuenta</th>
            <th>Contracuenta</th>
            <th>Monto</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="transactions-tbody">
          <!-- Filas din√°micas desde Firestore -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Toast de notificaciones -->
  <div id="toast" class="toast"></div>

  <!-- =============================== -->
  <!-- Firebase SDK e inicializaci√≥n   -->
  <!-- =============================== -->
  <script type="module">
    // =========================================
    // Importar Firebase SDK modular (v10.12+)
    // =========================================
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { 
      getFirestore, collection, doc, addDoc, getDocs, setDoc, updateDoc, deleteDoc,
      query, where, orderBy, runTransaction, serverTimestamp, enableNetwork, disableNetwork
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // =========================================
    // Configuraci√≥n de tu proyecto Firebase
    // =========================================
    const firebaseConfig = {
      apiKey: "AIzaSyA_Zn5FMQVPXCH9cPc0Yqk0O0K96wRdtK0",
      authDomain: "crm-familiar.firebaseapp.com",
      projectId: "crm-familiar",
      storageBucket: "crm-familiar.firebasestorage.app",
      messagingSenderId: "676787680550",
      appId: "1:676787680550:web:2a31780e5a0af802d37de7"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =========================================
    // Utilidades de formato y fecha
    // =========================================
    const fmtCOP = new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 });
    const toCOP = (v)=> fmtCOP.format(Number(v||0));

    const today = new Date();
    const pad = (n)=> String(n).padStart(2,'0');
    const yyyy = today.getFullYear();
    const mm = pad(today.getMonth()+1);
    const dd = pad(today.getDate());
    const currentMonthKey = `${yyyy}-${mm}`;

    // =========================================
    // Estado global y configuraci√≥n
    // =========================================
    const FAMILY_ID = 'familia-serrano'; // ID fijo familia, o usa Auth si tienes autenticaci√≥n
    let availableMonths = []; // Se carga desde Firestore
    let selectedMonth = currentMonthKey;
    let accounts = []; // Cuentas del mes actual
    let transactions = []; // Transacciones del mes actual

    // Cuentas base (se crean autom√°ticamente si no existen)
    const BASE_ACCOUNTS = [
      { id:'nequi-esposa', nombre:'Nequi Esposa', tipo:'nequi', titular:'esposa', saldo:0 },
      { id:'daviplata-esposa', nombre:'Daviplata Esposa', tipo:'daviplata', titular:'esposa', saldo:0 },
      { id:'daviplata-mio', nombre:'Daviplata M√≠o', tipo:'daviplata', titular:'mio', saldo:0 },
      { id:'ahorro-esposa', nombre:'Ahorros Esposa', tipo:'ahorro', titular:'esposa', saldo:0 },
      { id:'ahorro-mio', nombre:'Ahorros M√≠o', tipo:'ahorro', titular:'mio', saldo:0 },
      { id:'efectivo', nombre:'Efectivo', tipo:'efectivo', titular:'familia', saldo:0 },
    ];

    // =========================================
    // Helpers Firebase: paths de colecciones
    // =========================================
    function getAccountsCollection(month = selectedMonth) {
      return collection(db, 'families', FAMILY_ID, 'months', month, 'accounts');
    }

    function getTransactionsCollection(month = selectedMonth) {
      return collection(db, 'families', FAMILY_ID, 'months', month, 'transactions');
    }

    function getAccountDoc(accountId, month = selectedMonth) {
      return doc(db, 'families', FAMILY_ID, 'months', month, 'accounts', accountId);
    }

    // =========================================
    // UI: Toast de mensajes
    // =========================================
    const toastEl = document.getElementById('toast');
    function showToast(msg, kind='success'){
      toastEl.textContent = msg;
      toastEl.className = `toast show ${kind}`;
      setTimeout(()=> toastEl.className='toast', 3000);
    }

    // =========================================
    // Estado de conexi√≥n
    // =========================================
    const statusEl = document.getElementById('connection-status');
    function updateConnectionStatus(connected) {
      if (connected) {
        statusEl.className = 'status status-connected';
        statusEl.innerHTML = '<i class="fas fa-circle-check"></i> Conectado a Firebase Firestore ‚òÅÔ∏è';
      } else {
        statusEl.className = 'status status-disconnected';
        statusEl.innerHTML = '<i class="fas fa-circle-xmark"></i> Sin conexi√≥n a Firebase';
      }
    }

    // =========================================
    // Cargar datos desde Firebase
    // =========================================
    async function loadAccounts(month = selectedMonth) {
      try {
        const accountsCol = getAccountsCollection(month);
        const snapshot = await getDocs(accountsCol);
        
        if (snapshot.empty) {
          // Crear cuentas base si no existen
          console.log('üè¶ Creando cuentas base para el mes', month);
          for (const baseAccount of BASE_ACCOUNTS) {
            const accountDoc = doc(accountsCol, baseAccount.id);
            await setDoc(accountDoc, {
              ...baseAccount,
              createdAt: serverTimestamp()
            });
          }
          // Recargar despu√©s de crear
          return loadAccounts(month);
        }

        accounts = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        console.log('‚úÖ Cuentas cargadas:', accounts.length);
        return accounts;
      } catch (error) {
        console.error('‚ùå Error cargando cuentas:', error);
        showToast('Error cargando cuentas de Firebase', 'error');
        return [];
      }
    }

    async function loadTransactions(month = selectedMonth) {
      try {
        const transactionsCol = getTransactionsCollection(month);
        const q = query(transactionsCol, orderBy('fecha', 'desc'));
        const snapshot = await getDocs(q);
        
        transactions = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        console.log('‚úÖ Transacciones cargadas:', transactions.length);
        return transactions;
      } catch (error) {
        console.error('‚ùå Error cargando transacciones:', error);
        showToast('Error cargando transacciones de Firebase', 'error');
        return [];
      }
    }

    // =========================================
    // Descubrir meses disponibles
    // =========================================
    async function discoverAvailableMonths() {
      try {
        // En Firestore, las subcolecciones no se pueden enumerar directamente
        // Simulamos con los meses conocidos, o podr√≠as mantener una colecci√≥n "months" aparte
        const months = [];
        const currentYear = new Date().getFullYear();
        
        // Generar √∫ltimos 12 meses + pr√≥ximos 3
        for (let i = -12; i <= 3; i++) {
          const date = new Date(currentYear, today.getMonth() + i, 1);
          const monthKey = `${date.getFullYear()}-${pad(date.getMonth() + 1)}`;
          months.push(monthKey);
        }
        
        // Verificar cu√°les realmente existen (tienen cuentas)
        const existingMonths = [];
        for (const month of months) {
          try {
            const accountsCol = getAccountsCollection(month);
            const snapshot = await getDocs(accountsCol);
            if (!snapshot.empty) {
              existingMonths.push(month);
            }
          } catch (e) {
            // Mes no existe, continuar
          }
        }

        // Asegurar que al menos el mes actual existe
        if (!existingMonths.includes(currentMonthKey)) {
          existingMonths.push(currentMonthKey);
        }

        availableMonths = existingMonths.sort();
        console.log('üìÖ Meses disponibles:', availableMonths);
        return availableMonths;
      } catch (error) {
        console.error('‚ùå Error descubriendo meses:', error);
        availableMonths = [currentMonthKey];
        return availableMonths;
      }
    }

    // =========================================
    // UI: Selector de mes
    // =========================================
    const monthSelector = document.getElementById('month-selector');
    const newMonthBtn = document.getElementById('new-month-btn');

    function renderMonthSelector(){
      monthSelector.innerHTML = '';
      availableMonths.forEach(monthKey=>{
        const opt = document.createElement('option');
        opt.value = monthKey;
        const [y,m] = monthKey.split('-');
        const monthName = new Date(parseInt(y), parseInt(m) - 1).toLocaleDateString('es-CO', { 
          year: 'numeric', 
          month: 'long' 
        });
        opt.textContent = monthName;
        monthSelector.appendChild(opt);
      });
      monthSelector.value = selectedMonth;
    }

    monthSelector.addEventListener('change', async ()=>{
      selectedMonth = monthSelector.value;
      await refreshAll();
      showToast(`Mes ${selectedMonth} cargado üìÖ`,'success');
    });

    newMonthBtn.addEventListener('click', async ()=>{
      newMonthBtn.disabled = true;
      try {
        // Crear siguiente mes
        const [y,m] = selectedMonth.split('-').map(Number);
        const nextMonth = new Date(y, m, 1); // m es 1-indexado, por eso m sin -1
        const nextMonthKey = `${nextMonth.getFullYear()}-${pad(nextMonth.getMonth() + 1)}`;

        if (availableMonths.includes(nextMonthKey)) {
          selectedMonth = nextMonthKey;
          await refreshAll();
          showToast(`Mes ${nextMonthKey} ya existe, cambiado üìÖ`,'success');
        } else {
          // Copiar saldos actuales como saldos iniciales del nuevo mes
          const currentBalances = computeBalances(accounts, transactions);
          const newAccounts = accounts.map(account => ({
            ...account,
            saldo: currentBalances[account.id] || 0
          }));

          // Crear cuentas en el nuevo mes
          const newAccountsCol = getAccountsCollection(nextMonthKey);
          for (const account of newAccounts) {
            const accountDoc = doc(newAccountsCol, account.id);
            await setDoc(accountDoc, {
              ...account,
              createdAt: serverTimestamp()
            });
          }

          availableMonths.push(nextMonthKey);
          availableMonths.sort();
          selectedMonth = nextMonthKey;
          
          renderMonthSelector();
          await refreshAll();
          showToast('Nuevo mes creado con saldos de cierre ‚úÖ','success');
        }
      } catch (error) {
        console.error('‚ùå Error creando nuevo mes:', error);
        showToast('Error creando nuevo mes', 'error');
      } finally {
        newMonthBtn.disabled = false;
      }
    });

    // =========================================
    // C√°lculo de saldos (doble partida)
    // =========================================
    function computeBalances(accountsList, transactionsList) {
      const balances = {};
      
      // Inicializar con saldos base de las cuentas
      accountsList.forEach(account => {
        balances[account.id] = Number(account.saldo || 0);
      });

      // Aplicar transacciones
      transactionsList.forEach(tx => {
        const amount = Number(tx.monto || 0);
        
        if (tx.tipo === 'ingreso') {
          // Ingreso: aumenta la cuenta destino
          balances[tx.cuentaId] = (balances[tx.cuentaId] || 0) + amount;
        } else if (tx.tipo === 'gasto') {
          // Gasto: disminuye la cuenta de pago
          balances[tx.cuentaId] = (balances[tx.cuentaId] || 0) - amount;
        } else if (tx.tipo === 'transferencia') {
          // Transferencia: disminuye cuenta origen, aumenta cuenta destino
          balances[tx.cuentaId] = (balances[tx.cuentaId] || 0) - amount;
          balances[tx.contracuentaId] = (balances[tx.contracuentaId] || 0) + amount;
        }
      });

      return balances;
    }

    // =========================================
    // UI: Render cuentas y estad√≠sticas
    // =========================================
    const accountsGrid = document.getElementById('accounts-grid');

    function accountCssClass(tipo) {
      const classes = {
        'nequi': 'account-nequi',
        'daviplata': 'account-daviplata', 
        'ahorro': 'account-ahorro',
        'efectivo': 'account-efectivo'
      };
      return classes[tipo] || '';
    }

    function renderAccounts() {
      accountsGrid.innerHTML = '';
      const balances = computeBalances(accounts, transactions);
      
      accounts.forEach(account => {
        const currentBalance = balances[account.id] || 0;
        const div = document.createElement('div');
        div.className = `account-card ${accountCssClass(account.tipo)}`;
        div.innerHTML = `
          <h4>${account.nombre}</h4>
          <div class="account-meta">Titular: <strong>${account.titular}</strong> ‚Ä¢ Tipo: <strong>${account.tipo}</strong></div>
          <div class="account-balance">${toCOP(currentBalance)}</div>
          <div class="small muted">Saldo inicial: ${toCOP(account.saldo || 0)}</div>
        `;
        accountsGrid.appendChild(div);
      });

      // Actualizar estad√≠sticas generales
      const totalIncome = transactions.filter(t => t.tipo === 'ingreso').reduce((sum, t) => sum + Number(t.monto || 0), 0);
      const totalExpense = transactions.filter(t => t.tipo === 'gasto').reduce((sum, t) => sum + Number(t.monto || 0), 0);
      const savings = totalIncome - totalExpense;
      const totalBalance = Object.values(balances).reduce((sum, balance) => sum + Number(balance || 0), 0);

      document.getElementById('total-income').textContent = toCOP(totalIncome);
      document.getElementById('income-value').textContent = toCOP(totalIncome);
      document.getElementById('total-expense').textContent = toCOP(totalExpense);
      document.getElementById('expense-value').textContent = toCOP(totalExpense);
      document.getElementById('total-savings').textContent = toCOP(savings);
      document.getElementById('balance-value').textContent = toCOP(savings);
      document.getElementById('total-balance').textContent = toCOP(totalBalance);
    }

    // =========================================
    // UI: Llenar selects de cuentas
    // =========================================
    function fillAccountSelects() {
      const selects = [
        document.getElementById('income-account'),
        document.getElementById('expense-paid-with'),
        document.getElementById('transfer-from'),
        document.getElementById('transfer-to')
      ];

      selects.forEach(select => {
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = '<option value="">Seleccionar...</option>';
        
        accounts.forEach(account => {
          const option = document.createElement('option');
          option.value = account.id;
          option.textContent = account.nombre;
          select.appendChild(option);
        });

        // Restaurar valor seleccionado si a√∫n existe
        if (currentValue && accounts.find(a => a.id === currentValue)) {
          select.value = currentValue;
        }
      });
    }

    // =========================================
    // UI: Render tabla de transacciones
    // =========================================
    const txTable = document.getElementById('transactions-table');
    const txTBody = document.getElementById('transactions-tbody');
    const loadingTx = document.getElementById('loading-transactions');

    function renderTransactions() {
      txTBody.innerHTML = '';
      
      transactions.forEach(tx => {
        const tr = document.createElement('tr');
        const badgeClass = {
          'ingreso': 'badge-income',
          'gasto': 'badge-expense', 
          'transferencia': 'badge-transfer'
        }[tx.tipo] || 'badge-transfer';

        const categoria = tx.categoria || '‚Äî';
        const cuenta = accounts.find(a => a.id === tx.cuentaId)?.nombre || '‚Äî';
        const contracuenta = tx.contracuentaId 
          ? (accounts.find(a => a.id === tx.contracuentaId)?.nombre || '‚Äî')
          : '‚Äî';

        tr.innerHTML = `
          <td>${tx.fecha || ''}</td>
          <td><span class="badge ${badgeClass}">${tx.tipo}</span></td>
          <td>${categoria}</td>
          <td>${tx.descripcion || ''}</td>
          <td>${cuenta}</td>
          <td>${contracuenta}</td>
          <td><strong>${toCOP(tx.monto || 0)}</strong></td>
          <td>
            <button class="action-btn" title="Eliminar" onclick="deleteTransaction('${tx.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        txTBody.appendChild(tr);
      });

      // Mostrar/ocultar tabla vs loading
      if (transactions.length > 0) {
        loadingTx.style.display = 'none';
        txTable.style.display = 'table';
      } else {
        loadingTx.innerHTML = '<p style="text-align:center; color:var(--gray);">No hay transacciones registradas para este mes</p>';
        txTable.style.display = 'none';
      }
    }

    // =========================================
    // CRUD: Eliminar transacci√≥n
    // =========================================
    window.deleteTransaction = async function(txId) {
      if (!confirm('¬øEliminar esta transacci√≥n?')) return;
      
      try {
        const txDoc = doc(getTransactionsCollection(), txId);
        await deleteDoc(txDoc);
        
        // Actualizar estado local
        transactions = transactions.filter(t => t.id !== txId);
        renderTransactions();
        renderAccounts();
        
        showToast('Transacci√≥n eliminada ‚úÖ', 'success');
      } catch (error) {
        console.error('‚ùå Error eliminando transacci√≥n:', error);
        showToast('Error eliminando transacci√≥n', 'error');
      }
    };

    // =========================================
    // CRUD: Registrar ingreso
    // =========================================
    document.getElementById('income-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('income-submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

      try {
        const transactionData = {
          tipo: 'ingreso',
          categoria: document.getElementById('income-source').value,
          monto: Number(document.getElementById('income-amount').value || 0),
          fecha: document.getElementById('income-date').value,
          descripcion: document.getElementById('income-description').value.trim(),
          cuentaId: document.getElementById('income-account').value,
          contracuentaId: null,
          createdAt: serverTimestamp()
        };

        // Validaci√≥n
        if (!transactionData.cuentaId || !transactionData.monto || !transactionData.fecha || !transactionData.categoria) {
          throw new Error('Completa todos los campos obligatorios');
        }

        // Guardar en Firestore
        const transactionsCol = getTransactionsCollection();
        const docRef = await addDoc(transactionsCol, transactionData);
        
        // Actualizar estado local
        transactions.unshift({ ...transactionData, id: docRef.id });
        
        // Refrescar UI
        renderTransactions();
        renderAccounts();
        
        // Limpiar formulario
        e.target.reset();
        document.getElementById('income-date').value = `${yyyy}-${mm}-${dd}`;
        
        showToast('Ingreso registrado ‚úÖ', 'success');
      } catch (error) {
        console.error('‚ùå Error registrando ingreso:', error);
        showToast('Error: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span class="btn-text"><i class="fas fa-plus-circle"></i> Registrar Ingreso</span>';
      }
    });

    // =========================================
    // CRUD: Registrar gasto
    // =========================================
    document.getElementById('expense-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('expense-submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

      try {
        const transactionData = {
          tipo: 'gasto',
          categoria: document.getElementById('expense-category').value,
          monto: Number(document.getElementById('expense-amount').value || 0),
          fecha: document.getElementById('expense-date').value,
          descripcion: document.getElementById('expense-description').value.trim(),
          cuentaId: document.getElementById('expense-paid-with').value,
          contracuentaId: null,
          createdAt: serverTimestamp()
        };

        // Validaci√≥n
        if (!transactionData.cuentaId || !transactionData.monto || !transactionData.fecha || !transactionData.categoria) {
          throw new Error('Completa todos los campos obligatorios');
        }

        // Guardar en Firestore
        const transactionsCol = getTransactionsCollection();
        const docRef = await addDoc(transactionsCol, transactionData);
        
        // Actualizar estado local
        transactions.unshift({ ...transactionData, id: docRef.id });
        
        // Refrescar UI
        renderTransactions();
        renderAccounts();
        
        // Limpiar formulario
        e.target.reset();
        document.getElementById('expense-date').value = `${yyyy}-${mm}-${dd}`;
        
        showToast('Gasto registrado ‚úÖ', 'success');
      } catch (error) {
        console.error('‚ùå Error registrando gasto:', error);
        showToast('Error: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span class="btn-text"><i class="fas fa-plus-circle"></i> Registrar Gasto</span>';
      }
    });

    // =========================================
    // CRUD: Registrar transferencia (at√≥mica)
    // =========================================
    document.getElementById('transfer-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fromId = document.getElementById('transfer-from').value;
      const toId = document.getElementById('transfer-to').value;
      const amount = Number(document.getElementById('transfer-amount').value || 0);
      const fecha = document.getElementById('transfer-date').value;
      const descripcion = document.getElementById('transfer-description').value.trim();

      // Validaciones
      if (!fromId || !toId || !amount || !fecha) {
        showToast('Completa todos los campos obligatorios', 'error');
        return;
      }
      if (fromId === toId) {
        showToast('Las cuentas origen y destino deben ser diferentes', 'error');
        return;
      }

      try {
        // Usar runTransaction para operaci√≥n at√≥mica
        await runTransaction(db, async (transaction) => {
          // Leer cuentas actuales
          const fromAccountRef = getAccountDoc(fromId);
          const toAccountRef = getAccountDoc(toId);
          const fromAccountSnap = await transaction.get(fromAccountRef);
          const toAccountSnap = await transaction.get(toAccountRef);

          if (!fromAccountSnap.exists() || !toAccountSnap.exists()) {
            throw new Error('Una de las cuentas no existe');
          }

          // Verificar saldo suficiente (calculando saldo actual)
          const currentBalances = computeBalances(accounts, transactions);
          const currentFromBalance = currentBalances[fromId] || 0;
          
          if (currentFromBalance < amount) {
            throw new Error(`Saldo insuficiente. Disponible: ${toCOP(currentFromBalance)}`);
          }

          // Registrar la transacci√≥n
          const transactionsCol = getTransactionsCollection();
          const transferRef = doc(transactionsCol);
          transaction.set(transferRef, {
            tipo: 'transferencia',
            categoria: null,
            monto: amount,
            fecha,
            descripcion,
            cuentaId: fromId,
            contracuentaId: toId,
            createdAt: serverTimestamp()
          });

          // Actualizar estado local con nueva transacci√≥n
          const newTransaction = {
            id: transferRef.id,
            tipo: 'transferencia',
            categoria: null,
            monto: amount,
            fecha,
            descripcion,
            cuentaId: fromId,
            contracuentaId: toId
          };

          return newTransaction;
        });

        // Si llegamos aqu√≠, la transacci√≥n fue exitosa
        // Recargar datos para asegurar consistencia
        await loadTransactions();
        renderTransactions();
        renderAccounts();
        
        // Limpiar formulario
        e.target.reset();
        document.getElementById('transfer-date').value = `${yyyy}-${mm}-${dd}`;
        
        showToast('Transferencia realizada ‚úÖ', 'success');
      } catch (error) {
        console.error('‚ùå Error en transferencia:', error);
        showToast('Error: ' + error.message, 'error');
      }
    });

    // =========================================
    // UI: Sidebar m√≥vil
    // =========================================
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const menuBtn = document.getElementById('menu-toggle');

    menuBtn?.addEventListener('click', ()=>{
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    });

    overlay?.addEventListener('click', ()=>{
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
    });

    // =========================================
    // Funci√≥n principal: cargar todo
    // =========================================
    async function refreshAll() {
      try {
        loadingTx.style.display = 'block';
        txTable.style.display = 'none';
        
        // Cargar datos en paralelo
        const [accountsData, transactionsData] = await Promise.all([
          loadAccounts(selectedMonth),
          loadTransactions(selectedMonth)
        ]);
        
        // Actualizar UI
        fillAccountSelects();
        renderAccounts();
        renderTransactions();
        renderMonthSelector();
        
        updateConnectionStatus(true);
      } catch (error) {
        console.error('‚ùå Error refrescando datos:', error);
        updateConnectionStatus(false);
        showToast('Error cargando datos de Firebase', 'error');
      }
    }

    // =========================================
    // Inicializaci√≥n
    // =========================================
    async function initializeApp() {
      try {
        console.log('üöÄ Inicializando CRM Familiar...');
        
        // Establecer fechas por defecto
        document.getElementById('income-date').value = `${yyyy}-${mm}-${dd}`;
        document.getElementById('expense-date').value = `${yyyy}-${mm}-${dd}`;
        document.getElementById('transfer-date').value = `${yyyy}-${mm}-${dd}`;
        
        // Cargar meses disponibles
        await discoverAvailableMonths();
        
        // Asegurar que selectedMonth existe en la lista
        if (!availableMonths.includes(selectedMonth)) {
          selectedMonth = availableMonths[availableMonths.length - 1] || currentMonthKey;
        }
        
        // Cargar datos iniciales
        await refreshAll();
        
        // Habilitar bot√≥n de nuevo mes
        newMonthBtn.disabled = false;
        
        console.log('‚úÖ CRM Familiar inicializado correctamente');
        showToast('CRM Familiar conectado a Firebase ‚úÖ', 'success');
        
      } catch (error) {
        console.error('‚ùå Error inicializando aplicaci√≥n:', error);
        updateConnectionStatus(false);
        showToast('Error inicializando la aplicaci√≥n', 'error');
        
        // Habilitar funcionalidad b√°sica aunque falle
        fillAccountSelects();
        renderAccounts();
        renderTransactions();
      }
    }

    // =========================================
    // Iniciar la aplicaci√≥n
    // =========================================
    initializeApp();

  </script>
</body>
</html>
